{% extends "admin_base.html" %}

{% block title %}配置管理 - tg2emall{% endblock %}
{% block page_icon %}cogs{% endblock %}
{% block page_title %}配置管理{% endblock %}

{% block extra_css %}
<style>
    .config-section {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
    }
    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    .config-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 0;
    }
    .config-item label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
    }
    .config-description {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 5px;
        line-height: 1.4;
    }
    .config-key {
        font-size: 0.75rem;
        color: #868e96;
        font-family: 'Courier New', monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        margin-bottom: 5px;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
                <!-- 配置表单 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">系统配置</h5>
                    </div>
                    <div class="card-body">
                        <form id="configForm">
                            {% for group_name, configs in config_groups.items() %}
                            <div class="config-section">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-{{ 'cog' if group_name == 'general' else 'server' if group_name == 'service' else 'database' if group_name == 'database' else 'shield-alt' if group_name == 'security' else 'search' if group_name == 'seo' else 'chart-line' }} me-2"></i>
                                    {{ group_name|title }} 配置
                                </h6>
                                
                                <div class="config-grid">
                                {% for config in configs %}
                                <div class="config-item">
                                        <div class="config-key">{{ config.config_key }}</div>
                                    <label for="{{ config.config_key }}" class="form-label">
                                            {% set config_names = {
                                                'site_name': '网站名称',
                                                'site_description': '网站描述',
                                                'site_keywords': '网站关键词',
                                                'site_author': '网站作者',
                                                'site_url': '网站地址',
                                                'site_logo': '网站Logo',
                                                'seo_title_template': 'SEO标题模板',
                                                'seo_description_length': 'SEO描述长度',
                                                'seo_enable_og_tags': '启用Open Graph标签',
                                                'seo_enable_twitter_cards': '启用Twitter卡片',
                                                'google_analytics': 'Google Analytics',
                                                'baidu_tongji': '百度统计',
                                                'enable_structured_data': '启用结构化数据',
                                                'admin_username': '管理员用户名',
                                                'admin_password': '管理员密码',
                                                'admin_captcha': '管理员验证码',
                                                'mysql_host': 'MySQL主机',
                                                'mysql_port': 'MySQL端口',
                                                'mysql_user': 'MySQL用户名',
                                                'mysql_password': 'MySQL密码',
                                                'mysql_database': 'MySQL数据库',
                                                'redis_host': 'Redis主机',
                                                'redis_port': 'Redis端口',
                                                'redis_password': 'Redis密码',
                                                'redis_db': 'Redis数据库',
                                                'scraper_interval': '采集间隔',
                                                'scraper_channels': '采集频道',
                                                'telegram_api_id': 'Telegram API ID',
                                                'telegram_api_hash': 'Telegram API Hash',
                                                'telegram_phone': 'Telegram手机号',
                                                'telegram_session_string': 'Telegram会话字符串',
                                                'telegram_verification_required': '需要Telegram验证',
                                                'telegram_verification_code': 'Telegram验证码',
                                                'telegram_verification_submitted': 'Telegram验证码已提交',
                                                'telegram_verification_message': 'Telegram验证消息',
                                                'telegram_session_valid': 'Telegram会话有效'
                                            } %}
                                            {{ config_names.get(config.config_key, config.config_key|replace('_', ' ')|title) }}
                                    </label>
                                    
                                    {% if config.config_type == 'boolean' %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               id="{{ config.config_key }}" 
                                               name="{{ config.config_key }}"
                                               value="true"
                                               {% if config.config_value == 'true' %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ config.config_key }}">
                                                启用
                                        </label>
                                    </div>
                                    {% elif config.config_type == 'text' %}
                                    <textarea class="form-control" 
                                              id="{{ config.config_key }}" 
                                              name="{{ config.config_key }}" 
                                              rows="3">{{ config.config_value }}</textarea>
                                    {% else %}
                                    <input type="{{ 'number' if config.config_type == 'integer' else 'text' }}" 
                                           class="form-control" 
                                           id="{{ config.config_key }}" 
                                           name="{{ config.config_key }}" 
                                           value="{{ config.config_value }}">
                                    {% endif %}
                                    
                                        {% if config.config_description %}
                                    <div class="config-description">
                                        {{ config.config_description }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                            
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>保存配置
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.getElementById('configForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const configData = {};
    
    // 处理表单数据
    for (let [key, value] of formData.entries()) {
        configData[key] = value;
    }
    
    // 处理复选框
    const checkboxes = this.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        configData[checkbox.name] = checkbox.checked ? 'true' : 'false';
    });
    
    // 发送请求
    fetch('/admin/config/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(configData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '配置更新成功',
                text: data.message,
                timer: 2000
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: '配置更新失败',
                text: data.message
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: '配置更新失败',
            text: '网络错误，请重试'
        });
    });
});
</script>
{% endblock %}
