{% extends "admin_base.html" %}

{% block title %}配置管理 - tg2emall{% endblock %}
{% block page_icon %}cogs{% endblock %}
{% block page_title %}配置管理{% endblock %}

{% block extra_css %}
<style>
    .config-section {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
    }
    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    .config-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 0;
    }
    .config-item label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
    }
    .config-description {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 5px;
        line-height: 1.4;
    }
    .config-key {
        font-size: 0.75rem;
        color: #868e96;
        font-family: 'Courier New', monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        margin-bottom: 5px;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
                <!-- 配置表单 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">系统配置</h5>
                    </div>
                    <div class="card-body">
                        <form id="configForm">
                            {% for group_name, configs in config_groups.items() %}
                            <div class="config-section">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-{{ 'cog' if group_name == 'general' else 'server' if group_name == 'service' else 'database' if group_name == 'database' else 'shield-alt' if group_name == 'security' else 'search' if group_name == 'seo' else 'chart-line' }} me-2"></i>
                                    {{ group_name|title }} 配置
                                </h6>
                                
                                <div class="config-grid">
                                    {% for config in configs %}
                                    <div class="config-item">
                                        <div class="config-key">{{ config.config_key }}</div>
                                        <label for="{{ config.config_key }}" class="form-label">
                                            {{ config.description or config.config_key }}
                                        </label>
                                        
                                        {% if config.config_type == 'boolean' %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="{{ config.config_key }}" 
                                                   name="{{ config.config_key }}"
                                                   value="true"
                                                   {% if config.config_value == 'true' %}checked{% endif %}>
                                            <label class="form-check-label" for="{{ config.config_key }}">
                                                启用
                                            </label>
                                        </div>
                                        {% elif config.config_type == 'text' %}
                                        <textarea class="form-control" 
                                                  id="{{ config.config_key }}" 
                                                  name="{{ config.config_key }}" 
                                                  rows="3">{{ config.config_value }}</textarea>
                                        {% else %}
                                        <input type="{{ 'number' if config.config_type == 'integer' else 'text' }}" 
                                               class="form-control" 
                                               id="{{ config.config_key }}" 
                                               name="{{ config.config_key }}" 
                                               value="{{ config.config_value }}">
                                        {% endif %}
                                        
                                        {% if config.config_description %}
                                        <div class="config-description">
                                            {{ config.config_description }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                            
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>保存配置
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.getElementById('configForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const configData = {};
    
    // 处理表单数据
    for (let [key, value] of formData.entries()) {
        configData[key] = value;
    }
    
    // 处理复选框
    const checkboxes = this.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        configData[checkbox.name] = checkbox.checked ? 'true' : 'false';
    });
    
    // 发送请求
    fetch('/admin/config/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(configData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '配置更新成功',
                text: data.message,
                timer: 2000
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: '配置更新失败',
                text: data.message
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: '配置更新失败',
            text: '网络错误，请重试'
        });
    });
});
</script>
{% endblock %}
