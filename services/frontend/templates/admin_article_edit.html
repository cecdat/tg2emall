{% extends "admin_base.html" %}

{% block title %}编辑文章 - tg2emall{% endblock %}
{% block page_icon %}edit{% endblock %}
{% block page_title %}编辑文章{% endblock %}

{% block extra_css %}
<style>
    .content-editor {
        min-height: 400px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
</style>
{% endblock %}

{% block content %}
                <!-- 编辑文章表单 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-edit me-2"></i>
                            编辑文章 #{{ article.id }}
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="editArticleForm">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="title" class="form-label">文章标题</label>
                                        <input type="text" class="form-control" id="title" name="title" 
                                               value="{{ article.title }}" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="content" class="form-label">文章内容</label>
                                        <textarea class="form-control content-editor" id="content" name="content" 
                                                  rows="15" required>{{ article.content }}</textarea>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="tags" class="form-label">标签</label>
                                        <input type="text" class="form-control" id="tags" name="tags" 
                                               value="{{ article.tags or '' }}" 
                                               placeholder="用逗号分隔多个标签">
                                        <div class="form-text">例如：技术,编程,Python</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="source_channel" class="form-label">来源频道</label>
                                        <input type="text" class="form-control" id="source_channel" name="source_channel" 
                                               value="{{ article.source_channel or '' }}" 
                                               placeholder="来源频道名称">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="sort_id" class="form-label">分类ID</label>
                                        <input type="number" class="form-control" id="sort_id" name="sort_id" 
                                               value="{{ article.sort_id or 0 }}" min="0">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">文章信息</label>
                                        <div class="card bg-light">
                                            <div class="card-body p-3">
                                                <small class="text-muted d-block">
                                                    <strong>ID:</strong> {{ article.id }}
                                                </small>
                                                <small class="text-muted d-block">
                                                    <strong>创建时间:</strong> {{ article.created_at.strftime('%Y-%m-%d %H:%M:%S') if article.created_at else '未知' }}
                                                </small>
                                                <small class="text-muted d-block">
                                                    <strong>点击量:</strong> {{ (article.click_count or 0)|format_number }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>保存修改
                                    </button>
                                    <a href="{{ url_for('admin_articles') }}" class="btn btn-secondary ms-2">
                                        <i class="fas fa-arrow-left me-1"></i>返回列表
                                    </a>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-outline-danger" onclick="deleteArticle({{ article.id }})">
                                        <i class="fas fa-trash me-1"></i>删除文章
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('editArticleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch(`/admin/article/{{ article.id }}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('文章更新成功');
            window.location.href = '/admin/articles';
        } else {
            alert('更新失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('更新失败');
    });
});

function deleteArticle(articleId) {
    if (confirm('确定要删除这篇文章吗？此操作不可恢复！')) {
        fetch(`/admin/article/${articleId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('删除成功');
                window.location.href = '/admin/articles';
            } else {
                alert('删除失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败');
        });
    }
}
</script>
{% endblock %}