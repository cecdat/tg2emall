# ğŸ³ ç»Ÿä¸€å®¹å™¨éƒ¨ç½²æ–¹æ¡ˆ

## ğŸ¯ **æ¶æ„å˜æ›´**

### **ä¿®æ”¹å‰ï¼ˆå¤šå®¹å™¨ï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tg2em-frontend â”‚  â”‚  tg2em-tgstate  â”‚  â”‚ tg2em-scrape    â”‚
â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚
â”‚  Flaskåº”ç”¨      â”‚  â”‚  Goå›¾ç‰‡æœåŠ¡     â”‚  â”‚ Pythoné‡‡é›†å™¨    â”‚
â”‚  ç«¯å£: 5000     â”‚  â”‚  ç«¯å£: 8088     â”‚  â”‚ æ— ç«¯å£          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  tg2em-mysql    â”‚
                    â”‚  MySQLæ•°æ®åº“    â”‚
                    â”‚  ç«¯å£: 3306     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ä¿®æ”¹åï¼ˆç»Ÿä¸€å®¹å™¨ï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    tg2em-unified                            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Flaskå‰ç«¯  â”‚  â”‚  Goå›¾ç‰‡æœåŠ¡ â”‚  â”‚ Pythoné‡‡é›†  â”‚        â”‚
â”‚  â”‚  ç«¯å£: 5000 â”‚  â”‚  ç«¯å£: 8088 â”‚  â”‚ è¿›ç¨‹ç®¡ç†    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              è¿›ç¨‹ç›‘æ§å’Œé‡å¯è„šæœ¬                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  tg2em-mysql    â”‚
                    â”‚  MySQLæ•°æ®åº“    â”‚
                    â”‚  ç«¯å£: 3306     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ **æ ¸å¿ƒä¼˜åŠ¿**

### **1. çœŸå®æœåŠ¡æ§åˆ¶**
- âœ… **è¿›ç¨‹çº§ç®¡ç†**: ä½¿ç”¨ `psutil` å’Œ `signal` è¿›è¡ŒçœŸå®çš„è¿›ç¨‹æ§åˆ¶
- âœ… **PIDè·Ÿè¸ª**: å®æ—¶è·Ÿè¸ªæ¯ä¸ªæœåŠ¡çš„è¿›ç¨‹ID
- âœ… **çŠ¶æ€ç›‘æ§**: çœŸå®çš„è¿›ç¨‹çŠ¶æ€æ£€æŸ¥ï¼Œéæ¨¡æ‹Ÿ

### **2. ç®€åŒ–éƒ¨ç½²**
- âœ… **å•ä¸€å®¹å™¨**: åªéœ€ç®¡ç†ä¸€ä¸ªä¸šåŠ¡å®¹å™¨
- âœ… **ç»Ÿä¸€æ—¥å¿—**: æ‰€æœ‰æœåŠ¡æ—¥å¿—é›†ä¸­ç®¡ç†
- âœ… **ç®€åŒ–ç½‘ç»œ**: å‡å°‘å®¹å™¨é—´é€šä¿¡å¤æ‚åº¦

### **3. è‡ªåŠ¨æ¢å¤**
- âœ… **è¿›ç¨‹ç›‘æ§**: è‡ªåŠ¨æ£€æµ‹è¿›ç¨‹æ­»äº¡
- âœ… **è‡ªåŠ¨é‡å¯**: è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯
- âœ… **å¥åº·æ£€æŸ¥**: æŒç»­ç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€

## ğŸ“ **æ–‡ä»¶ç»“æ„**

```
tg2emall/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ unified/
â”‚       â”œâ”€â”€ Dockerfile              # ç»Ÿä¸€å®¹å™¨æ„å»ºæ–‡ä»¶
â”‚       â”œâ”€â”€ start.sh               # æœåŠ¡å¯åŠ¨è„šæœ¬
â”‚       â”œâ”€â”€ service_manager.py     # è¿›ç¨‹ç®¡ç†ç¨‹åº
â”‚       â””â”€â”€ requirements.txt       # Pythonä¾èµ–
â”œâ”€â”€ docker-compose.yml             # æ›´æ–°çš„ç¼–æ’æ–‡ä»¶
â””â”€â”€ deploy.sh                      # æ›´æ–°çš„éƒ¨ç½²è„šæœ¬
```

## ğŸš€ **éƒ¨ç½²æ­¥éª¤**

### **1. æ„å»ºç»Ÿä¸€å®¹å™¨**
```bash
cd ~/tg2emall
docker-compose build unified
```

### **2. å¯åŠ¨æœåŠ¡**
```bash
# å¯åŠ¨æ ¸å¿ƒæœåŠ¡
docker-compose up -d mysql unified nginx-proxy-manager

# æŸ¥çœ‹çŠ¶æ€
docker-compose ps
```

### **3. æŸ¥çœ‹æ—¥å¿—**
```bash
# æŸ¥çœ‹ç»Ÿä¸€å®¹å™¨æ—¥å¿—
docker-compose logs -f unified

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker exec tg2em-unified tail -f /app/logs/frontend.log
docker exec tg2em-unified tail -f /app/logs/scraper.log
docker exec tg2em-unified tail -f /app/logs/tgstate.log
```

## ğŸ® **æœåŠ¡æ§åˆ¶**

### **ç®¡ç†ç•Œé¢æ§åˆ¶**
è®¿é—® http://localhost:5000/dm è¿›è¡ŒæœåŠ¡ç®¡ç†ï¼š

- **æœåŠ¡çŠ¶æ€**: æ˜¾ç¤ºçœŸå®çš„è¿›ç¨‹çŠ¶æ€å’ŒPID
- **å¯åŠ¨æœåŠ¡**: å‘é€å¯åŠ¨ä¿¡å·ç»™ç›‘æ§è„šæœ¬
- **åœæ­¢æœåŠ¡**: å‘é€SIGTERMä¿¡å·ç»ˆæ­¢è¿›ç¨‹
- **é‡å¯æœåŠ¡**: å…ˆåœæ­¢å†å¯åŠ¨

### **å‘½ä»¤è¡Œæ§åˆ¶**
```bash
# è¿›å…¥ç»Ÿä¸€å®¹å™¨
docker exec -it tg2em-unified /bin/bash

# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
ps aux | grep -E "(python|tgstate)"

# æ‰‹åŠ¨åœæ­¢æœåŠ¡
kill -TERM <PID>

# æŸ¥çœ‹PIDæ–‡ä»¶
cat /app/data/pids.env
```

## ğŸ” **è¿›ç¨‹ç®¡ç†æœºåˆ¶**

### **å¯åŠ¨æµç¨‹**
1. **å¯åŠ¨è„šæœ¬**: `start.sh` å¯åŠ¨æ‰€æœ‰æœåŠ¡
2. **PIDè®°å½•**: å°†è¿›ç¨‹IDä¿å­˜åˆ° `/app/data/pids.env`
3. **ç›‘æ§å¾ªç¯**: æ¯10ç§’æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
4. **è‡ªåŠ¨é‡å¯**: æ£€æµ‹åˆ°è¿›ç¨‹æ­»äº¡æ—¶è‡ªåŠ¨é‡å¯

### **æœåŠ¡æ§åˆ¶å™¨**
```python
# çœŸå®è¿›ç¨‹çŠ¶æ€æ£€æŸ¥
def get_service_status(self, service_name):
    pid = self.services[service_name]['pid']
    if psutil.pid_exists(pid):
        process = psutil.Process(pid)
        return 'running' if process.is_running() else 'stopped'
    return 'stopped'

# çœŸå®è¿›ç¨‹æ§åˆ¶
def stop_service(self, service_name):
    pid = self.services[service_name]['pid']
    os.kill(pid, signal.SIGTERM)  # å‘é€ç»ˆæ­¢ä¿¡å·
```

## ğŸ“Š **ç›‘æ§å’Œæ—¥å¿—**

### **æ—¥å¿—æ–‡ä»¶**
- `/app/logs/frontend.log` - Flaskå‰ç«¯æœåŠ¡æ—¥å¿—
- `/app/logs/scraper.log` - Telegramé‡‡é›†æœåŠ¡æ—¥å¿—  
- `/app/logs/tgstate.log` - å›¾ç‰‡ä¸Šä¼ æœåŠ¡æ—¥å¿—

### **çŠ¶æ€æ–‡ä»¶**
- `/app/data/pids.env` - è¿›ç¨‹IDè®°å½•æ–‡ä»¶
- æ ¼å¼: `FRONTEND_PID=1234\nSCRAPER_PID=5678\nTGSTATE_PID=9012`

### **å¥åº·æ£€æŸ¥**
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker exec tg2em-unified python3 -c "
from service_manager import service_manager
print(service_manager.get_service_status('frontend'))
print(service_manager.get_service_status('scraper'))
print(service_manager.get_service_status('tgstate'))
"
```

## ğŸ› ï¸ **æ•…éšœæ’é™¤**

### **æœåŠ¡æ— æ³•å¯åŠ¨**
```bash
# æ£€æŸ¥å®¹å™¨æ—¥å¿—
docker-compose logs unified

# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
docker exec tg2em-unified ps aux

# æ‰‹åŠ¨å¯åŠ¨æœåŠ¡
docker exec tg2em-unified /app/start.sh
```

### **è¿›ç¨‹ç®¡ç†é—®é¢˜**
```bash
# é‡æ–°åŠ è½½PIDæ–‡ä»¶
docker exec tg2em-unified python3 -c "
from service_manager import service_manager
service_manager.load_pids()
print('PIDæ–‡ä»¶å·²é‡æ–°åŠ è½½')
"

# é‡å¯ç›‘æ§è„šæœ¬
docker exec tg2em-unified pkill -f service_manager.py
docker exec tg2em-unified python3 /app/service_manager.py &
```

### **ç«¯å£å†²çª**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
docker exec tg2em-unified netstat -tlnp

# æ£€æŸ¥æœåŠ¡ç›‘å¬
docker exec tg2em-unified lsof -i :5000
docker exec tg2em-unified lsof -i :8088
```

## ğŸ‰ **ä¼˜åŠ¿æ€»ç»“**

### **âœ… è§£å†³çš„é—®é¢˜**
1. **Docker APIè¿æ¥é—®é¢˜**: ä¸å†éœ€è¦Docker socketæŒ‚è½½
2. **å®¹å™¨é—´é€šä¿¡**: æ‰€æœ‰æœåŠ¡åœ¨åŒä¸€å®¹å™¨å†…ï¼Œç›´æ¥è¿›ç¨‹é€šä¿¡
3. **æœåŠ¡æ§åˆ¶çœŸå®æ€§**: çœŸå®çš„è¿›ç¨‹ç®¡ç†ï¼Œéæ¨¡æ‹Ÿæ§åˆ¶
4. **éƒ¨ç½²ç®€åŒ–**: å•ä¸€å®¹å™¨éƒ¨ç½²ï¼Œå‡å°‘å¤æ‚åº¦

### **âœ… æ–°å¢åŠŸèƒ½**
1. **è‡ªåŠ¨è¿›ç¨‹ç›‘æ§**: æŒç»­ç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€
2. **è‡ªåŠ¨é‡å¯æœºåˆ¶**: è¿›ç¨‹å¼‚å¸¸æ—¶è‡ªåŠ¨æ¢å¤
3. **ç»Ÿä¸€æ—¥å¿—ç®¡ç†**: é›†ä¸­åŒ–çš„æ—¥å¿—æ”¶é›†
4. **çœŸå®çŠ¶æ€åé¦ˆ**: ç®¡ç†ç•Œé¢æ˜¾ç¤ºçœŸå®è¿›ç¨‹çŠ¶æ€

### **âœ… ç”¨æˆ·ä½“éªŒ**
1. **ç®¡ç†ç•Œé¢**: çœŸå®çš„æœåŠ¡æ§åˆ¶æŒ‰é’®
2. **çŠ¶æ€æ˜¾ç¤º**: å‡†ç¡®çš„è¿›ç¨‹çŠ¶æ€å’ŒPIDä¿¡æ¯
3. **æ“ä½œåé¦ˆ**: å³æ—¶çš„å¯åŠ¨/åœæ­¢æ“ä½œç»“æœ
4. **é”™è¯¯å¤„ç†**: å‹å¥½çš„é”™è¯¯ä¿¡æ¯æ˜¾ç¤º

**ç°åœ¨æ‚¨æ‹¥æœ‰äº†çœŸæ­£çš„æœåŠ¡æ§åˆ¶èƒ½åŠ›ï¼** ğŸš€
