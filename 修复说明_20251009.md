# tgState å›¾ç‰‡ä¸Šä¼ æœåŠ¡å¯åŠ¨é—®é¢˜ä¿®å¤è¯´æ˜

**æ—¥æœŸ**: 2025-10-09  
**ç¯å¢ƒ**: è¿œç¨‹ Debian 12 æœåŠ¡å™¨  
**é—®é¢˜**: tgstate æœåŠ¡å¯åŠ¨æŠ¥ 500 é”™è¯¯

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. **ç«¯å£é…ç½®é”™è¯¯** 
- **æ–‡ä»¶**: `services/tgstate/management-service.go`
- **é—®é¢˜**: æ—¥å¿—è¾“å‡ºç«¯å£ 8088ï¼Œä½†å®é™…ç›‘å¬ç«¯å£æ˜¯ 8001
- **ä¿®å¤**: ç¬¬ 112 è¡Œï¼Œä¿®æ­£æ—¥å¿—è¾“å‡ºä¸ºæ­£ç¡®çš„ç«¯å£ 8001

### 2. **å¯†ç éªŒè¯ä¸­é—´ä»¶é˜»æ­¢ API è®¿é—®**
- **æ–‡ä»¶**: `services/tgstate/management-service.go`  
- **é—®é¢˜**: ç®¡ç† API æ¥å£è¢«å¯†ç éªŒè¯ä¸­é—´ä»¶æ‹¦æˆªï¼Œå¯¼è‡´å‰ç«¯æ— æ³•è°ƒç”¨
- **ä¿®å¤**: åœ¨ä¸­é—´ä»¶ä¸­æ·»åŠ ç®¡ç† API è·¯ç”±ç™½åå•ï¼Œå…è®¸æ— å¯†ç è®¿é—®ï¼š
  - `/api/management/status`
  - `/api/management/start`
  - `/api/management/stop`
  - `/api/management/restart`
  - `/api/management/config`
  - `/api/management/info`
- **é¢å¤–**: æ·»åŠ äº† CORS æ”¯æŒï¼Œå…è®¸è·¨åŸŸè®¿é—®

### 3. **ç¯å¢ƒå˜é‡ URL é…ç½®é”™è¯¯**
- **æ–‡ä»¶**: `env.example`
- **é—®é¢˜**: TGSTATE_URL é…ç½®ä¸º `http://localhost:8088`ï¼ˆé”™è¯¯ç«¯å£ï¼‰
- **ä¿®å¤**: æ”¹ä¸º `http://localhost:8001`

### 4. **å®¹å™¨å†…éƒ¨ URL é…ç½®é”™è¯¯**
- **æ–‡ä»¶**: `docker-compose.yml`
- **é—®é¢˜**: å®¹å™¨é—´é€šä¿¡åº”ä½¿ç”¨å®¹å™¨åè€Œé localhost
- **ä¿®å¤**: å°† `http://localhost:8001` æ”¹ä¸º `http://tgstate:8001`

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶

ä¸ºæ–¹ä¾¿è¿œç¨‹éƒ¨ç½²ï¼Œæ–°å¢äº†ä»¥ä¸‹å·¥å…·å’Œæ–‡æ¡£ï¼š

### è„šæœ¬æ–‡ä»¶
1. âœ… **fix_tgstate_remote.sh** - Linux æœåŠ¡å™¨è‡ªåŠ¨ä¿®å¤è„šæœ¬
2. âœ… **fix_tgstate.sh** - é€šç”¨ä¿®å¤è„šæœ¬
3. âœ… **quick_fix.bat** - Windows å¿«é€Ÿä¿®å¤ï¼ˆå·²åˆ›å»ºä½†ä¸é€‚ç”¨è¿œç¨‹ï¼‰

### æ–‡æ¡£æ–‡ä»¶
1. âœ… **REMOTE_FIX_GUIDE.md** - è¿œç¨‹æœåŠ¡å™¨å®Œæ•´ä¿®å¤æŒ‡å—
2. âœ… **è¿œç¨‹ä¿®å¤æ­¥éª¤.md** - ç®€æ˜æ“ä½œæ­¥éª¤ï¼ˆä¸­æ–‡ï¼‰
3. âœ… **START_SERVICES.md** - æœåŠ¡å¯åŠ¨å’Œç®¡ç†æŒ‡å—
4. âœ… **TGSTATE_FIX_GUIDE.md** - tgState æœåŠ¡è¯¦ç»†ä¿®å¤æŒ‡å—

---

## ğŸš€ è¿œç¨‹æœåŠ¡å™¨ä½¿ç”¨æ–¹æ³•

### æœ€ç®€å•çš„æ–¹å¼ï¼ˆæ¨èï¼‰

```bash
# SSH è¿æ¥åˆ°æœåŠ¡å™¨å
cd /path/to/tg2emall
git pull
chmod +x fix_tgstate_remote.sh
./fix_tgstate_remote.sh
```

### æ‰‹åŠ¨ä¿®å¤æ–¹å¼

```bash
cd /path/to/tg2emall
git pull
docker-compose stop tgstate
docker-compose rm -f tgstate
docker-compose build --no-cache tgstate
docker-compose up -d tgstate
docker-compose logs -f tgstate
```

---

## ğŸ” éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š

```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose ps tgstate
# æœŸæœ›: STATUS ä¸º Up

# 2. æµ‹è¯•ç®¡ç† API
curl http://localhost:8001/api/management/status
# æœŸæœ›: {"success":true,"data":{...}}

# 3. ä»å‰ç«¯å®¹å™¨æµ‹è¯•ï¼ˆå®¹å™¨é—´é€šä¿¡ï¼‰
docker exec -it tg2em-frontend curl http://tgstate:8001/api/management/status
# æœŸæœ›: {"success":true,"data":{...}}
```

---

## ğŸ—ï¸ æœåŠ¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tg2em-tgstate å®¹å™¨                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ management-service (8001)       â”‚   â”‚
â”‚  â”‚  - ç®¡ç† API                      â”‚   â”‚
â”‚  â”‚  - å¯åŠ¨/åœæ­¢ä¸Šä¼ æœåŠ¡              â”‚   â”‚
â”‚  â”‚  - é…ç½®ç®¡ç†                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚ åŠ¨æ€å¯åŠ¨/åœæ­¢               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ upload-service (8002)           â”‚   â”‚
â”‚  â”‚  - å›¾ç‰‡ä¸Šä¼ åˆ° Telegram           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²
         â”‚ HTTP è°ƒç”¨
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tg2em-frontend (8000)    â”‚
â”‚  - å‰ç«¯æœåŠ¡                â”‚
â”‚  - ä½¿ç”¨ tgstate:8001      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰
- âŒ ç®¡ç† API è¢«å¯†ç éªŒè¯æ‹¦æˆª â†’ 500 é”™è¯¯
- âŒ æ—¥å¿—æ˜¾ç¤ºé”™è¯¯ç«¯å£ 8088ï¼ˆå®é™…æ˜¯ 8001ï¼‰
- âŒ ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯çš„ URL
- âŒ å‰ç«¯æ— æ³•è°ƒç”¨ tgstate ç®¡ç†æ¥å£

### ä¿®å¤å
- âœ… ç®¡ç† API å¯ä»¥æ­£å¸¸è®¿é—®ï¼ˆæ— éœ€å¯†ç ï¼‰
- âœ… æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®ç«¯å£
- âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- âœ… å‰ç«¯å¯ä»¥æ­£å¸¸å¯åŠ¨/åœæ­¢ tgstate æœåŠ¡
- âœ… æ”¯æŒ CORS è·¨åŸŸè®¿é—®
- âœ… å®¹å™¨é—´é€šä¿¡æ­£å¸¸

---

## ğŸ› ï¸ æŠ€æœ¯ç»†èŠ‚

### ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
```
modified:   services/tgstate/management-service.go
modified:   env.example
modified:   docker-compose.yml
```

### å…³é”®ä»£ç ä¿®æ”¹

**1. ä¸­é—´ä»¶ç™½åå• (management-service.go:403-423)**
```go
// ç®¡ç† API è·¯ç”±ä¸éœ€è¦å¯†ç éªŒè¯ï¼ˆç”¨äºå†…éƒ¨æœåŠ¡è°ƒç”¨ï¼‰
if r.URL.Path == "/api/management/status" ||
   r.URL.Path == "/api/management/start" ||
   r.URL.Path == "/api/management/stop" ||
   r.URL.Path == "/api/management/restart" ||
   r.URL.Path == "/api/management/config" ||
   r.URL.Path == "/api/management/info" {
    // å…è®¸è·¨åŸŸè®¿é—®ï¼ˆCORSï¼‰
    w.Header().Set("Access-Control-Allow-Origin", "*")
    w.Header().Set("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    w.Header().Set("Access-Control-Allow-Headers", "Content-Type")
    
    // å¤„ç† OPTIONS é¢„æ£€è¯·æ±‚
    if r.Method == "OPTIONS" {
        w.WriteHeader(http.StatusOK)
        return
    }
    
    next.ServeHTTP(w, r)
    return
}
```

**2. ç«¯å£é…ç½® (docker-compose.yml:102)**
```yaml
URL: "${TGSTATE_URL:-http://tgstate:8001}"  # ä½¿ç”¨å®¹å™¨å
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å¿«é€Ÿå¼€å§‹**: [è¿œç¨‹ä¿®å¤æ­¥éª¤.md](./è¿œç¨‹ä¿®å¤æ­¥éª¤.md)
- **å®Œæ•´æŒ‡å—**: [REMOTE_FIX_GUIDE.md](./REMOTE_FIX_GUIDE.md)
- **æœåŠ¡ç®¡ç†**: [START_SERVICES.md](./START_SERVICES.md)

---

## ğŸ’¡ åç»­å»ºè®®

### 1. é…ç½®ç›‘æ§
å»ºè®®é…ç½®æœåŠ¡ç›‘æ§ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ï¼š
```bash
# å®‰è£… ctop å®¹å™¨ç›‘æ§
wget https://github.com/bcicen/ctop/releases/download/v0.7.7/ctop-0.7.7-linux-amd64 \
  -O /usr/local/bin/ctop
chmod +x /usr/local/bin/ctop
```

### 2. é…ç½®æ—¥å¿—è½®è½¬
ç¼–è¾‘ `/etc/docker/daemon.json`:
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

### 3. è®¾ç½®è‡ªåŠ¨å¤‡ä»½
åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤‡ä»½æ•°æ®ï¼š
```bash
# æ·»åŠ åˆ° crontab
0 2 * * * cd /path/to/tg2emall && docker exec tg2em-mysql mysqldump -u tg2emall -ptg2emall tg2em > backup_$(date +\%Y\%m\%d).sql
```

### 4. é…ç½®åå‘ä»£ç†
ä½¿ç”¨ Nginx åå‘ä»£ç†ï¼Œä¸è¦ç›´æ¥æš´éœ² Docker ç«¯å£åˆ°å…¬ç½‘ã€‚

---

## âœ‰ï¸ åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥å¸®åŠ©ï¼Œè¯·æä¾›ï¼š
1. å®¹å™¨æ—¥å¿—: `docker-compose logs tgstate`
2. å®¹å™¨çŠ¶æ€: `docker-compose ps`
3. ç³»ç»Ÿä¿¡æ¯: `uname -a`

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-09  
**é€‚ç”¨ç¯å¢ƒ**: Debian 12 / Ubuntu / CentOS ç­‰ Linux æœåŠ¡å™¨  
**Docker ç‰ˆæœ¬è¦æ±‚**: Docker 20.10+ / Docker Compose 1.29+

